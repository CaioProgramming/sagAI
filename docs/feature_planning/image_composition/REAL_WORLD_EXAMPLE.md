# Reviewer Agent - Real-World Example

## Scenario: Generating Gizella (PUNK_ROCK Character)

### Input to System

```json
{
  "character": {
    "name": "Gizella",
    "personality": "Rebellious, defiant, cynical",
    "appearance": "Red and black hair, leather jacket, ripped t-shirt, combat boots",
    "ethnicity": "Caucasian",
    "gender": "Female",
    "age": 22
  },
  "visualReference": "Portrait/Close-up shot"
}
```

---

## Step 1: Art Director Generates Description

**Generated by `iconDescription()` prompt:**

```
Gizella's expression is one of defiant introspection, a subtle sneer playing 
on her lips. Her jaw is sharply angular, and her mouth is a bold, crooked line. 
Her eyes are cast brown, conveying a sense of guarded intensity. A small scar 
is visible above her left eyebrow. Her hair is a vibrant, chaotic mess of red 
and black, pulled back into a high, messy ponytail. She wears a black oversized 
leather jacket, heavily worn and covered in patches. A black iPhone with a 
cracked screen and a skull sticker is clutched loosely in her right hand. 
Her combat boots are scuffed and worn. Her skin is pale, with subtle shadows 
emphasizing her cheekbones. The overall mood is rebellious and melancholic.
```

**Problems:**

1. ‚ùå "cast brown" eyes (PUNK_ROCK requires "simple black dot eyes")
2. ‚ùå Describes combat boots (not visible in portrait framing)
3. ‚ùå No background described (PUNK_ROCK requires 3+ environmental objects)
4. ‚ùå "subtle shadows" (should be "hard cel-shading")

---

## Step 2: Reviewer Analyzes

**Inputs to `reviewAndCorrectPrompt()`:**

```kotlin
visualDirection = "FRAMING: Close-up Portrait. Subject occupies lower 70% of frame..."
artStyleValidationRules = GenrePrompts.validationRules(PUNK_ROCK)
strictness = ReviewerStrictness.STRICT
finalPrompt = [description above]
```

**Reviewer's Analysis:**

### Violation 1: Banned Terminology

- **Type**: `BANNED_TERMINOLOGY`
- **Severity**: `MAJOR`
- **Description**: "Used 'cast brown' for eyes when style requires dot eyes"
- **Example**: "Her eyes are cast brown"

### Violation 2: Framing Violation

- **Type**: `FRAMING_VIOLATION`
- **Severity**: `CRITICAL`
- **Description**: "Described combat boots which are not visible in portrait framing"
- **Example**: "Her combat boots are scuffed and worn"

### Violation 3: Missing Elements

- **Type**: `MISSING_ELEMENTS`
- **Severity**: `CRITICAL`
- **Description**: "No background described - PUNK_ROCK style requires 3+ specific objects"

### Violation 4: Style Contradiction

- **Type**: `STYLE_CONTRADICTION`
- **Severity**: `MAJOR`
- **Description**: "Used 'subtle shadows' when style requires 'hard cel-shading'"
- **Example**: "subtle shadows emphasizing her cheekbones"

---

## Step 3: Reviewer Corrects

**Corrected Description:**

```
A gritty Gorillaz-style cartoon illustration with bold black outlines and 
flat cel-shading. Close-up portrait framing, subject anchored in lower 70% 
of frame.

Gizella's expression is one of defiant introspection, a subtle sneer playing 
on her lips. Her jaw is sharply angular, and her mouth is a bold, crooked line. 
Her eyes are simple black dots‚Äîhollow and void-like‚Äîconveying a sense of 
guarded intensity through their stark simplicity. A small scar is visible above 
her left eyebrow. Her hair is a vibrant, chaotic mess of acid green and black, 
pulled back into a high, messy ponytail with angular cartoon strands escaping 
to frame her angular face. She wears a black oversized leather jacket, heavily 
worn and covered in patches and scribbled graffiti. A black iPhone with a 
cracked screen and a skull sticker is clutched loosely in her right hand, 
angled as if she's just been jotting down lyrics.

Behind her, a graffiti-covered brick wall serves as the backdrop‚Äîspray-painted 
tags in acid green and white, tattered band posters (some ripped, revealing 
layers beneath), and a flickering neon sign casting a sickly green glow across 
the scene. An amp stack is barely visible in the corner, covered in stickers. 
The composition uses hard cel-shading with stark graphic shadows‚Äîno gradients, 
just flat blocks of shadow defining her features. Her skin is pale and flat, 
with angular cel-shaded shadows emphasizing her cheekbones and jawline. 
The overall mood is rebellious and melancholic, captured in a gritty 2D 
cartoon aesthetic.
```

**Changes Applied:**

1. ‚úÖ Replaced "cast brown eyes" with "simple black dots‚Äîhollow and void-like"
2. ‚úÖ Removed "combat boots" description (not visible in portrait)
3. ‚úÖ Added detailed background: brick wall, graffiti, neon sign, amp stack, posters
4. ‚úÖ Changed "subtle shadows" to "hard cel-shading with stark graphic shadows"
5. ‚úÖ Added art style declaration at beginning
6. ‚úÖ Emphasized cartoon proportions and flat rendering

---

## Step 4: Analytics Output

**Console Log:**

```
üñºÔ∏è Image Generation: reviewAndCorrectPrompt: Starting review with STRICT strictness
‚úèÔ∏è Prompt was modified by reviewer
Violations detected: 4
  - CRITICAL: 2
  - MAJOR: 2
  - MINOR: 0
Changes applied:
  ‚Ä¢ Replaced banned eye terminology: 'cast brown eyes' ‚Üí 'simple black dots‚Äîhollow and void-like'
  ‚Ä¢ Removed framing violation: Deleted description of combat boots (not visible in portrait shot)
  ‚Ä¢ Added missing background elements: brick wall with graffiti, neon sign, tattered band posters, amp stack
  ‚Ä¢ Fixed style contradiction: Changed 'subtle shadows' to 'hard cel-shading with stark graphic shadows'
‚ö†Ô∏è CRITICAL violations found - prompt was completely wrong!
```

**Returned Object:**

```kotlin
ImagePromptReview(
    originalPrompt = "[original text]",
    correctedPrompt = "[corrected text]",
    violations = listOf(
        PromptViolation(
            type = BANNED_TERMINOLOGY,
            severity = MAJOR,
            description = "Used 'cast brown' for eyes when style requires dot eyes",
            example = "Her eyes are cast brown"
        ),
        PromptViolation(
            type = FRAMING_VIOLATION,
            severity = CRITICAL,
            description = "Described combat boots not visible in portrait",
            example = "Her combat boots are scuffed"
        ),
        PromptViolation(
            type = MISSING_ELEMENTS,
            severity = CRITICAL,
            description = "No background described",
            example = null
        ),
        PromptViolation(
            type = STYLE_CONTRADICTION,
            severity = MAJOR,
            description = "Used 'subtle shadows' instead of cel-shading",
            example = "subtle shadows emphasizing"
        )
    ),
    changesApplied = listOf(
        "Replaced banned eye terminology...",
        "Removed framing violation...",
        "Added missing background elements...",
        "Fixed style contradiction..."
    ),
    wasModified = true
)

// Analytics
review.isCompletelyWrong = true // Has CRITICAL violations
review.violationsBySeverity = mapOf(CRITICAL to 2, MAJOR to 2)
review.violationsByType = mapOf(
    FRAMING_VIOLATION to 1,
    BANNED_TERMINOLOGY to 1,
    MISSING_ELEMENTS to 1,
    STYLE_CONTRADICTION to 1
)
```

---

## Step 5: Image Generation

**Final Prompt Used:**
The **corrected** description is sent to the image generation model.

**Result:**
A proper PUNK_ROCK style image with:

- ‚úÖ Simple black dot eyes
- ‚úÖ Cartoon proportions
- ‚úÖ Hard cel-shading
- ‚úÖ Rich background with graffiti, neon, and band posters
- ‚úÖ Portrait framing (no boots visible)
- ‚úÖ Gorillaz-style aesthetic

---

## Comparison: With vs Without Reviewer

### WITHOUT Reviewer (Old System)

**Sent to Image Model:**

```
...Her eyes are cast brown, conveying a sense of guarded intensity...
Her combat boots are scuffed and worn...
[No background described]
```

**Result:**
‚ùå Realistic brown eyes (breaks cartoon style)
‚ùå Image might show boots (wrong framing)
‚ùå Plain/gradient background (violates style requirements)
‚ùå Wrong rendering style

### WITH Reviewer (New System)

**Sent to Image Model:**

```
...Her eyes are simple black dots‚Äîhollow and void-like...
[No boots mentioned]
Behind her, a graffiti-covered brick wall with neon signs...
Hard cel-shading with stark graphic shadows...
```

**Result:**
‚úÖ Correct stylized dot eyes
‚úÖ Proper portrait framing
‚úÖ Rich, detailed background
‚úÖ Proper cartoon rendering

---

## Performance Impact

**Before:**

```
1. Extract composition (1-2s)
2. Generate description (2-3s)
3. Generate image (8-10s)
Total: ~11-15s
```

**After:**

```
1. Extract composition (1-2s)
2. Generate description (2-3s)
3. [NEW] Review description (1-2s)
4. Generate image (8-10s)
Total: ~12-17s (+1-2s)
```

**Trade-off:** 10-15% slower, but significantly higher quality and fewer failed generations.

---

## Edge Cases Handled

### 1. Reviewer Fails

```kotlin
val reviewedPrompt = imagenClient.reviewAndCorrectPrompt(...)
val finalPrompt = reviewedPrompt?.correctedPrompt ?: originalDescription
// ‚úÖ Falls back to original, generation never blocks
```

### 2. JSON Parse Error

```kotlin
} catch (e: Exception) {
    Log.e(TAG, "Failed to parse review JSON, using original prompt", e)
    return ImagePromptReview(
        originalPrompt = originalPrompt,
        correctedPrompt = originalPrompt,
        violations = emptyList(),
        wasModified = false
    )
}
// ‚úÖ Returns original on parse failure
```

### 3. No Violations

```json
{
  "correctedPrompt": "[same as original]",
  "violations": [],
  "changesApplied": [],
  "wasModified": false
}
```

Log: `‚úì Prompt passed review without modifications`

---

## Future: Analytics Dashboard

With this data, you could build:

### Violation Heatmap by Genre

```
PUNK_ROCK: 
  - BANNED_TERMINOLOGY: 87% of generations
  - MISSING_ELEMENTS: 62% of generations
  
FANTASY:
  - STYLE_CONTRADICTION: 12% of generations
  - FRAMING_VIOLATION: 8% of generations
```

### Quality Improvement Metrics

```
Before Reviewer: 45% success rate
After Reviewer: 89% success rate
‚Üí 44% improvement
```

### Most Common Fixes

```
1. "Eye color replacements" - 342 occurrences
2. "Background additions" - 298 occurrences
3. "Framing corrections" - 156 occurrences
```

This data helps identify which base prompts need improvement!

