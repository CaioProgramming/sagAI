name: Android APK - Build and Artifact Only

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      buildVariant:
        description: 'Gradle build variant to assemble (Debug or Release)'
        required: true
        default: 'Debug'

jobs:
  build-apk:
    runs-on: ubuntu-latest

    env:
      # Module that produces the APK
      ANDROID_MODULE: app
      # Default variant; can be overridden via workflow_dispatch input
      BUILD_VARIANT: ${{ github.event.inputs.buildVariant || 'Debug' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare config.properties âš™ï¸
        shell: bash
        run: |
          set -euo pipefail
          echo "[CI] Working dir: $(pwd)"
          mkdir -p app
          # Fail fast if secret is empty (will not print it)
          if [ -z "${{ secrets.GEMINI_KEY }}" ]; then
            echo "[CI][ERROR] GEMINI_KEY secret is empty or not configured." >&2
            exit 2
          fi
          {
            echo "GEMINI_KEY = \"${{ secrets.GEMINI_KEY }}\"";
          } > app/config.properties
          chmod 600 app/config.properties
          # Optionally mirror into assets if project expects it there (safe if not used)
          mkdir -p app/src/main/assets
          cp app/config.properties app/src/main/assets/config.properties
          chmod 600 app/src/main/assets/config.properties || true
          # Non-secret diagnostics
          echo "[CI] Wrote app/config.properties"
          ls -l app/config.properties || true
          echo "[CI] Also mirrored to app/src/main/assets/config.properties"; ls -l app/src/main/assets/config.properties || true
          echo "[CI] Showing sanitized preview (no values):"
          # Print only the key names without values
          awk -F'=' '{ gsub(/ /,""); key=$1; if (length(key)>0) print key " = \"***\"" }' app/config.properties
          echo "[CI] app folder listing:"; ls -la app || true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Cache Android build tools (gradle wrapper will handle most cache)
        run: echo "Using Gradle cache via setup-gradle action"

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # If you want to sign a release, provide the keystore secrets and uncomment the signing step below.
      # Otherwise we build Debug which does not require signing keys.
      - name: APK ShippingðŸ“¦
        run: |
          set -euo pipefail
          VARIANT_LOWER=$(echo "${BUILD_VARIANT}" | tr '[:upper:]' '[:lower:]')
          echo "[CI] Checking config.properties before build:"
          if [ -f app/config.properties ]; then
            echo "[CI] app/config.properties exists"; ls -l app/config.properties
            echo "[CI] Sanitized content:"; awk -F'=' '{ gsub(/ /,"" ); key=$1; if (length(key)>0) print key " = \"***\"" }' app/config.properties
          else
            echo "[CI][ERROR] app/config.properties is missing." >&2
            exit 3
          fi
          ./gradlew :${ANDROID_MODULE}:assemble${BUILD_VARIANT} --stacktrace
          echo "APK_PATH=${ANDROID_MODULE}/build/outputs/apk/${VARIANT_LOWER}/" >> $GITHUB_ENV

      - name: Locate generated APK
        id: locate_apk
        run: |
          VARIANT_LOWER=$(echo "${BUILD_VARIANT}" | tr '[:upper:]' '[:lower:]')
          # Prefer universal APK if using app bundles/splits, otherwise fallback to app-{variant}.apk
          APK_FILE=$(ls ${ANDROID_MODULE}/build/outputs/apk/${VARIANT_LOWER}/*.apk | head -n 1)
          if [ -z "$APK_FILE" ]; then
            echo "No APK found in ${ANDROID_MODULE}/build/outputs/apk/${VARIANT_LOWER}" >&2
            exit 1
          fi
          echo "apk=$APK_FILE" >> $GITHUB_OUTPUT

      - name: Upload APK as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ env.BUILD_VARIANT }}
          path: ${{ steps.locate_apk.outputs.apk }}

# ---------------------------
# Notes:
# - This simplified workflow only builds the APK and uploads it as a GitHub Actions artifact.
# - Use the workflow_dispatch input 'buildVariant' to choose Debug or Release.
# - If you later want to re-enable Firebase App Distribution, restore the removed steps and required secrets.
# - For signed Release builds, ensure your Gradle signingConfigs read values from env vars or properties and add a keystore preparation step if needed.
