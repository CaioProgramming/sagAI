name: Bump version and open PR

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Compute next version
        id: bump
        run: |
          FILE="version.properties"
          if [ ! -f "$FILE" ]; then
            echo "version.properties not found" >&2
            exit 1
          fi
          # Read current values (defaulting to 0 if missing)
          MAJOR=$(grep -E '^MAJOR=' "$FILE" | cut -d'=' -f2)
          MINOR=$(grep -E '^MINOR=' "$FILE" | cut -d'=' -f2)
          PATCH=$(grep -E '^PATCH=' "$FILE" | cut -d'=' -f2)
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}

          # Ensure numeric
          if ! [[ $MAJOR =~ ^[0-9]+$ && $MINOR =~ ^[0-9]+$ && $PATCH =~ ^[0-9]+$ ]]; then
            echo "Non-numeric version component(s)." >&2
            exit 1
          fi

          # Bump logic: increase PATCH 0..10; if it reaches 10 and we need to bump further, roll to MINOR and reset PATCH to 0.
          # As per requirement: values go from 1 to 10; however current repo has PATCH=0. We'll support 0..10 and roll over at 10.
          newMajor=$MAJOR
          newMinor=$MINOR
          newPatch=$PATCH

          if [ "$PATCH" -lt 10 ]; then
            newPatch=$((PATCH + 1))
          else
            # PATCH is 10 -> reset to 0 and bump MINOR
            newPatch=0
            if [ "$MINOR" -lt 10 ]; then
              newMinor=$((MINOR + 1))
            else
              # MINOR is 10 -> reset to 0 and bump MAJOR
              newMinor=0
              newMajor=$((MAJOR + 1))
            fi
          fi

          echo "Current: $MAJOR.$MINOR.$PATCH"
          echo "Next:    $newMajor.$newMinor.$newPatch"

          if [ "$MAJOR" = "$newMajor" ] && [ "$MINOR" = "$newMinor" ] && [ "$PATCH" = "$newPatch" ]; then
            echo "No change in version. Skipping." >&2
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Write back to file while preserving comment header line if present
          {
            # Preserve any first comment line starting with '#'
            head -n 1 "$FILE" | grep -q '^#' && head -n 1 "$FILE" || true
            echo "MAJOR=$newMajor"
            echo "MINOR=$newMinor"
            echo "PATCH=$newPatch"
          } > version.properties.tmp
          mv version.properties.tmp "$FILE"

          echo "changed=true" >> $GITHUB_OUTPUT
          echo "version=$newMajor.$newMinor.$newPatch" >> $GITHUB_OUTPUT

      - name: Build Signed APK
        uses: TeamNecta/build-signed-apk@main
        with:
          keystore_b64: ${{ secrets.KEY_STORE }}
          keystore_password: ${{ secrets.KEY_STORE_PASS }}
          key_alias: ${{ secrets.KEY_STORE_ALIAS }}
          key_password: ${{ secrets.ALIAS_PASS }}

      - name: ⬆️ Upload artifact
        id: upload_artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ steps.bump.outputs.version }}
          path: app/build/outputs/apk/release/app-release.apk

      - name: Create Pull Request
        if: steps.bump.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(version): bump to ${{ steps.bump.outputs.version }}"
          title: "Release: ${{ steps.bump.outputs.version }}"
          body: |
            Automated version bump on push to main.
            - Previous version: see commit history
            - New version: ${{ steps.bump.outputs.version }}
          branch: "release/version-${{ steps.bump.outputs.version }}"
          labels: |
            automation
            version
          add-paths: |
            version.properties
          signoff: false
          draft: false
