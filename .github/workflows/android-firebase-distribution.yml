name: Android APK - Build and Artifact Only

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      buildVariant:
        description: 'Gradle build variant to assemble (Debug or Release)'
        required: true
        default: 'Debug'

jobs:
  build-apk:
    # Run for pull requests only if the PR has the 'feature' label; for push/workflow_dispatch, run as usual
    if: >-
      ${{ github.event_name != 'pull_request' || contains(join(github.event.pull_request.labels.*.name, ','), 'feature') }}
    runs-on: ubuntu-latest

    env:
      # Module that produces the APK
      ANDROID_MODULE: app
      # Default variant; can be overridden via workflow_dispatch input
      BUILD_VARIANT: ${{ github.event.inputs.buildVariant || 'Debug' }}

    steps:
      - name: ðŸ§° Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Make script executable
        run: chmod +x scripts/prepare-config.sh

      - name: âš™ï¸ Prepare config.properties
        shell: bash
        env:
          GEMINI_KEY: ${{ secrets.GEMINI_KEY }}
        run: |
          set -euo pipefail
          echo "[CI] Working dir: $(pwd)"
          ./scripts/prepare-config.sh

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ§± Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: ðŸ—„ï¸ Enable caches
        run: echo "Using Gradle cache via setup-gradle action"

      - name: ðŸ”§ chmod gradlew
        run: chmod +x ./gradlew

      # If you want to sign a release, provide the keystore secrets and uncomment the signing step below.
      # Otherwise we build Debug which does not require signing keys.
      - name: ðŸ—ï¸ Build APK
        run: |
          set -euo pipefail
          VARIANT_LOWER=$(echo "${BUILD_VARIANT}" | tr '[:upper:]' '[:lower:]')
          echo "[CI] Checking config.properties before build:"
          if [ -f app/config.properties ]; then
            echo "[CI] app/config.properties exists"; ls -l app/config.properties
            echo "[CI] Sanitized content:"; awk -F'=' '{ gsub(/ /,"" ); key=$1; if (length(key)>0) print key " = \"***\"" }' app/config.properties
          else
            echo "[CI][ERROR] app/config.properties is missing." >&2
            exit 3
          fi
          ./gradlew :${ANDROID_MODULE}:assemble${BUILD_VARIANT} --stacktrace
          echo "APK_PATH=${ANDROID_MODULE}/build/outputs/apk/${VARIANT_LOWER}/" >> $GITHUB_ENV

      - name: ðŸ”Ž Find APK
        id: locate_apk
        run: |
          VARIANT_LOWER=$(echo "${BUILD_VARIANT}" | tr '[:upper:]' '[:lower:]')
          # Prefer universal APK if using app bundles/splits, otherwise fallback to app-{variant}.apk
          APK_FILE=$(ls ${ANDROID_MODULE}/build/outputs/apk/${VARIANT_LOWER}/*.apk | head -n 1)
          if [ -z "$APK_FILE" ]; then
            echo "No APK found in ${ANDROID_MODULE}/build/outputs/apk/${VARIANT_LOWER}" >&2
            exit 1
          fi
          echo "apk=$APK_FILE" >> $GITHUB_OUTPUT

      - name: â¬†ï¸ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ env.BUILD_VARIANT }}
          path: ${{ steps.locate_apk.outputs.apk }}

      - name: ðŸ’¬ PR comment
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) { core.info('Not a PR event, skipping comment'); return; }
            const title = pr.title || 'N/A';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const body = `[Feature] ${title} APK [artifact](${runUrl}) ready to test`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body
            });

      - name: ðŸ“ Summary
        if: ${{ github.event_name == 'pull_request' }}
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "[Feature] ${PR_TITLE} APK (artifact) ready to test? -> https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" >> $GITHUB_STEP_SUMMARY

# ---------------------------
# Notes:
# - This simplified workflow only builds the APK and uploads it as a GitHub Actions artifact.
# - Use the workflow_dispatch input 'buildVariant' to choose Debug or Release.
# - If you later want to re-enable Firebase App Distribution, restore the removed steps and required secrets.
# - For signed Release builds, ensure your Gradle signingConfigs read values from env vars or properties and add a keystore preparation step if needed.
