name: Android APK - Firebase App Distribution

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      buildVariant:
        description: 'Gradle build variant to assemble (Debug or Release)'
        required: true
        default: 'Debug'
      testers:
        description: 'Comma-separated list of tester emails (overrides secret if set)'
        required: false
      groups:
        description: 'Comma-separated list of tester groups (overrides secret if set)'
        required: false

jobs:
  build-and-distribute:
    runs-on: ubuntu-latest

    env:
      # Module that produces the APK
      ANDROID_MODULE: app
      # Default variant; can be overridden via workflow_dispatch input
      BUILD_VARIANT: ${{ github.event.inputs.buildVariant || 'Debug' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Cache Android build tools (gradle wrapper will handle most cache)
        run: echo "Using Gradle cache via setup-gradle action"

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # If you want to sign a release, provide the keystore secrets and uncomment the signing step below.
      # Otherwise we build Debug which does not require signing keys.
      - name: Assemble APK
        run: |
          VARIANT_LOWER=$(echo "${BUILD_VARIANT}" | tr '[:upper:]' '[:lower:]')
          ./gradlew :${ANDROID_MODULE}:assemble${BUILD_VARIANT}
          echo "APK_PATH=${ANDROID_MODULE}/build/outputs/apk/${VARIANT_LOWER}/" >> $GITHUB_ENV

      - name: Locate generated APK
        id: locate_apk
        run: |
          VARIANT_LOWER=$(echo "${BUILD_VARIANT}" | tr '[:upper:]' '[:lower:]')
          # Prefer universal APK if using app bundles/splits, otherwise fallback to app-{variant}.apk
          APK_FILE=$(ls ${ANDROID_MODULE}/build/outputs/apk/${VARIANT_LOWER}/*.apk | head -n 1)
          if [ -z "$APK_FILE" ]; then
            echo "No APK found in ${ANDROID_MODULE}/build/outputs/apk/${VARIANT_LOWER}" >&2
            exit 1
          fi
          echo "apk=$APK_FILE" >> $GITHUB_OUTPUT

      - name: Upload APK as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ env.BUILD_VARIANT }}
          path: ${{ steps.locate_apk.outputs.apk }}

      - name: Set testers/groups values
        id: dist_inputs
        run: |
          TESTERS_INPUT="${{ github.event.inputs.testers }}"
          GROUPS_INPUT="${{ github.event.inputs.groups }}"
          echo "testers=${TESTERS_INPUT:-${{ secrets.FIREBASE_TESTERS }}}" >> $GITHUB_OUTPUT
          echo "groups=${GROUPS_INPUT:-${{ secrets.FIREBASE_GROUPS }}}" >> $GITHUB_OUTPUT

      - name: Distribute to Firebase App Distribution
        if: ${{ secrets.FIREBASE_TOKEN != '' && secrets.FIREBASE_APP_ID != '' }}
        uses: w9jds/firebase-action@v13.27.0
        with:
          args: appdistribution:distribute "${{ steps.locate_apk.outputs.apk }}" --app "${{ secrets.FIREBASE_APP_ID }}" $EXTRA_FLAGS
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          # Compose extra flags based on testers/groups presence
          EXTRA_FLAGS: >-
            ${{ steps.dist_inputs.outputs.testers && format('--testers "{0}"', steps.dist_inputs.outputs.testers) || '' }}
            ${{ steps.dist_inputs.outputs.groups && format(' --groups "{0}"', steps.dist_inputs.outputs.groups) || '' }}

      - name: Hint when distribution is skipped
        if: ${{ secrets.FIREBASE_TOKEN == '' || secrets.FIREBASE_APP_ID == '' }}
        run: |
          echo "Firebase distribution skipped because FIREBASE_TOKEN or FIREBASE_APP_ID is not set as a GitHub Secret." >&2
          echo "Please add the required secrets (see this workflow file for details)."

# ---------------------------
# Required GitHub Secrets (set in repo Settings > Secrets and variables > Actions):
# - FIREBASE_TOKEN: CI token from 'firebase login:ci' (or a Service Account JSON with GOOGLE_APPLICATION_CREDENTIALS approach; this workflow uses token).
# - FIREBASE_APP_ID: Your Firebase Android App ID (format: 1:1234567890:android:abcdef1234567890). Find it in Firebase console > Project settings.
# Optional Secrets:
# - FIREBASE_TESTERS: Comma-separated emails to receive builds. Example: user1@example.com,user2@example.com
# - FIREBASE_GROUPS: Comma-separated tester groups in Firebase. Example: android-testers,qa
# - ANDROID_SIGNING_STORE_FILE: Base64-encoded keystore file (only needed for signed release builds)
# - ANDROID_SIGNING_STORE_PASSWORD: Keystore password
# - ANDROID_SIGNING_KEY_ALIAS: Key alias
# - ANDROID_SIGNING_KEY_PASSWORD: Key password
#
# Notes:
# - By default, this workflow assembles the Debug APK which does not require signing. To produce a signed Release:
#   1) Ensure your Gradle signingConfigs for release read values from environment variables or Gradle properties.
#   2) Add a step before Assemble to decode the base64 keystore and export signing vars, e.g.:
#        - name: Prepare signing keystore
#          run: |
#            echo "$ANDROID_SIGNING_STORE_FILE" | base64 -d > keystore.jks
#            echo "storeFile=$(pwd)/keystore.jks" >> $GITHUB_ENV
#          env:
#            ANDROID_SIGNING_STORE_FILE: ${{ secrets.ANDROID_SIGNING_STORE_FILE }}
#   3) Change buildVariant input default to 'Release' or dispatch workflow with buildVariant=Release.
# - To override testers/groups per run, dispatch the workflow manually and fill inputs or pass secrets.
